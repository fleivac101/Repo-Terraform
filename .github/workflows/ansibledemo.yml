name: Launch AAP Workflow (manual)

on:
  workflow_dispatch:
    inputs:
      wf_id:
        description: "AAP Workflow Job Template ID"
        required: true
        default: "29"
      extra_vars_json:
        description: "extra_vars as JSON (example: {\"key\":\"value\"})"
        required: false
        default: "{}"

jobs:
  run-aap:
    runs-on: ubuntu-latest

    steps:
      - name: Launch Workflow Job Template
        env:
          AAP_URL: ${{ secrets.AAP_URL }}
          AAP_TOKEN: ${{ secrets.AAP_TOKEN }}
          WF_ID: ${{ inputs.wf_id }}
          EXTRA_VARS: ${{ inputs.extra_vars_json }}
        run: |
          echo "Launching AAP Workflow Template ID: $WF_ID"
          echo "extra_vars: $EXTRA_VARS"

          RESPONSE=$(curl --globoff -sS -k -X POST \
            "$AAP_URL/api/controller/v2/workflow_job_templates/$WF_ID/launch/" \
            -H "Authorization: Bearer $AAP_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"extra_vars\": $EXTRA_VARS}")

          echo "$RESPONSE"

          WF_JOB_ID=$(echo "$RESPONSE" | jq -r '.workflow_job')

          if [ "$WF_JOB_ID" = "null" ] || [ -z "$WF_JOB_ID" ]; then
            echo "Failed to retrieve workflow job id"
            exit 1
          fi

          echo "WF_JOB_ID=$WF_JOB_ID" >> $GITHUB_ENV
          echo "Workflow Job ID: $WF_JOB_ID"

      - name: Wait for Workflow to Finish
        env:
          AAP_URL: ${{ secrets.AAP_URL }}
          AAP_TOKEN: ${{ secrets.AAP_TOKEN }}
        run: |
          echo "Polling Workflow Job: $WF_JOB_ID"

          for i in {1..90}; do
            DATA=$(curl -sS -k \
              "$AAP_URL/api/controller/v2/workflow_jobs/$WF_JOB_ID/" \
              -H "Authorization: Bearer $AAP_TOKEN")

            STATUS=$(echo "$DATA" | jq -r '.status')
            FAILED=$(echo "$DATA" | jq -r '.failed')

            echo "Status: $STATUS | failed: $FAILED"

            if [ "$STATUS" = "successful" ] && [ "$FAILED" = "false" ]; then
              echo "✅ Workflow succeeded"
              exit 0
            fi

            if [ "$STATUS" = "failed" ] || [ "$STATUS" = "error" ] || [ "$STATUS" = "canceled" ] || [ "$FAILED" = "true" ]; then
              echo "❌ Workflow failed"
              echo "Details: $AAP_URL/#/jobs/workflow/$WF_JOB_ID"
              exit 1
            fi

            sleep 10
          done

          echo "Timeout waiting for workflow"
          exit 1

