name: iac-governance

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  workflow_dispatch:
    inputs:
      location:
        description: "Azure location (example: eastus, westus2)"
        required: true
        default: "eastus"
      vm_size:
        description: "VM size (example: Standard_B2s)"
        required: true
        default: "Standard_B2s"
      break_tags:
        description: "Set to true to intentionally fail governance by removing costCenter tag"
        required: false
        default: "false"

jobs:
  terraform-plan-gate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: azuredemo/terraform
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.ARM_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).tenantId }}
        run: terraform init

      - name: Terraform Validate
        working-directory: azuredemo/terraform
        run: terraform validate

      # =========================
      # âœ… Nivel 2: IaC Security Scan (Checkov)
      # =========================
      - name: Install Checkov
        run: pip3 install checkov

      # 1) CLI output (para comentario en PR) - no bloquea
      - name: Checkov scan (CLI output)
        working-directory: azuredemo/terraform
        run: |
          set +e
          checkov -d . --framework terraform > ../checkov.txt
          exit 0

      # 2) SARIF vÃ¡lido (archivo)
      - name: Checkov scan (SARIF)
        working-directory: azuredemo/terraform
        run: |
          set +e
          checkov -d . --framework terraform --output sarif --output-file-path checkov.sarif
          exit 0

      # 3) Upload SARIF (si falla, NO corta el pipeline)
      - name: Upload Checkov SARIF
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: azuredemo/terraform/checkov.sarif

      # 4) Comentario en el PR (si es PR) con salida legible
      - name: Comment Checkov results on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = fs.readFileSync('azuredemo/checkov.txt', 'utf8');
            if (body.length > 60000) body = body.slice(0, 60000) + "\n...(truncated)";
            const comment = [
              "## ðŸ” Checkov â€“ IaC Security Scan",
              "```",
              body,
              "```"
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      # =========================
      # âœ… Nivel 1: Plan + Governance Gate
      # =========================
      - name: Terraform Plan
        working-directory: azuredemo/terraform
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.ARM_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).tenantId }}

          TF_VAR_location: ${{ github.event.inputs.location || 'eastus' }}
          TF_VAR_vm_size: ${{ github.event.inputs.vm_size || 'Standard_B2s' }}
          TF_VAR_tags: '{"owner":"fabian","costCenter":"demo","environment":"dev","application":"iac-governance"}'
        run: |
          # Demo fail: quitar costCenter
          if [ "${{ github.event.inputs.break_tags || 'false' }}" = "true" ]; then
            echo 'TF_VAR_tags={"owner":"fabian","environment":"dev","application":"iac-governance"}' >> $GITHUB_ENV
          fi

          terraform plan -out=tfplan

      - name: Export plan to JSON
        working-directory: azuredemo/terraform
        run: terraform show -json tfplan > tfplan.json

      - name: Analyze Terraform Plan (IaC Governance)
        run: python azuredemo/scripts/analyze_plan.py azuredemo/terraform/tfplan.json
