name: Azure Terraform Plan Gate

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - "azure/**"
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  push:
    branches: [ master, main ]
    paths:
      - "azure/**"
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  workflow_dispatch:
    inputs:
      location:name: iac-governance

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  workflow_dispatch:
    inputs:
      location:
        description: "Azure location (example: eastus, westus2)"
        required: true
        default: "eastus"
      vm_size:
        description: "VM size (example: Standard_B2s)"
        required: true
        default: "Standard_B2s"
      break_tags:
        description: "Set to true to intentionally fail governance by removing costCenter tag"
        required: false
        default: "false"

jobs:
  terraform-plan-gate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: azuredemo/terraform
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.ARM_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).tenantId }}
        run: terraform init

      - name: Terraform Validate
        working-directory: azuredemo/terraform
        run: terraform validate

      # =========================
      # âœ… Nivel 2: IaC Security Scan (Checkov)
      # =========================
      - name: Install Checkov
        run: pip3 install checkov

      # 1) CLI output (para comentario en PR) - no bloquea
      - name: Checkov scan (CLI output)
        working-directory: azuredemo/terraform
        run: |
          set +e
          checkov -d . --framework terraform > ../checkov.txt
          exit 0

      # 2) SARIF vÃ¡lido (archivo)
      - name: Checkov scan (SARIF)
        working-directory: azuredemo/terraform
        run: |
          set +e
          checkov -d . --framework terraform --output sarif --output-file-path checkov.sarif
          exit 0

      # 3) Upload SARIF (si falla, NO corta el pipeline)
      - name: Upload Checkov SARIF
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: azuredemo/terraform/checkov.sarif

      # 4) Comentario en el PR (si es PR) con salida legible
      - name: Comment Checkov results on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = fs.readFileSync('azuredemo/checkov.txt', 'utf8');
            if (body.length > 60000) body = body.slice(0, 60000) + "\n...(truncated)";
            const comment = [
              "## ðŸ” Checkov â€“ IaC Security Scan",
              "```",
              body,
              "```"
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      # =========================
      # âœ… Nivel 1: Plan + Governance Gate
      # =========================
      - name: Terraform Plan
        working-directory: azuredemo/terraform
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.ARM_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).tenantId }}

          TF_VAR_location: ${{ github.event.inputs.location || 'eastus' }}
          TF_VAR_vm_size: ${{ github.event.inputs.vm_size || 'Standard_B2s' }}
          TF_VAR_tags: '{"owner":"fabian","costCenter":"demo","environment":"dev","application":"iac-governance"}'
        run: |
          # Demo fail: quitar costCenter
          if [ "${{ github.event.inputs.break_tags || 'false' }}" = "true" ]; then
            echo 'TF_VAR_tags={"owner":"fabian","environment":"dev","application":"iac-governance"}' >> $GITHUB_ENV
          fi

          terraform plan -out=tfplan

      - name: Export plan to JSON
        working-directory: azuredemo/terraform
        run: terraform show -json tfplan > tfplan.json

      # =========================
      # ðŸŸ¢ OPCIÃ“N 1: Cost Estimation Gate (Infracost)
      # =========================
      - name: Install Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Run Infracost breakdown (from plan)
        working-directory: azuredemo/terraform
        run: |
          infracost breakdown \
            --path=tfplan.json \
            --format=json \
            --out-file=infracost.json

      - name: Show cost summary
        working-directory: azuredemo/terraform
        run: |
          infracost output \
            --path=infracost.json \
            --format=table

      - name: Enforce cost policy
        working-directory: azuredemo/terraform
        env:
          MAX_MONTHLY_USD: "50"
        run: |
          python - <<'PY'
          import json, os, sys
          max_cost = float(os.environ.get("MAX_MONTHLY_USD","50"))
          with open("infracost.json") as f:
            data = json.load(f)

          cost = data.get("totalMonthlyCost")
          if cost is None:
            print("âš ï¸ Could not read totalMonthlyCost from infracost.json; skipping policy.")
            sys.exit(0)

          cost = float(cost)
          print(f"Monthly cost estimate: ${cost:.2f} (max allowed ${max_cost:.2f})")

          if cost > max_cost:
            print(f"âŒ Cost exceeds allowed threshold ({max_cost} USD)")
            sys.exit(1)

          print("âœ… Cost policy passed")
          PY

      # =========================
      # âœ… AnÃ¡lisis de gobierno (tu script)
      # =========================
      - name: Analyze Terraform Plan (IaC Governance)
        run: python azuredemo/scripts/analyze_plan.py azuredemo/terraform/tfplan.json

        description: "Azure Region"
        required: true
        default: "eastus"
        type: choice
        options:
          - eastus
          - brazilsouth
          - westus
          - centralus

      vm_size:
        description: "Virtual Machine Size"
        required: true
        default: "Standard_B2s"
        type: choice
        options:
          - Standard_B1s
          - Standard_B2s
          - Standard_D2s_v3
          - Standard_D4s_v3

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TF_WORKING_DIR: azuredemo
  TF_IN_AUTOMATION: "true"

jobs:
  terraform-plan-gate:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      # ---------------------------
      # CHECKOV
      # ---------------------------

      - name: Install Checkov
        run: pip install checkov

      - name: Checkov scan (CLI output)
        run: checkov -d . || true

      - name: Checkov scan (JSON)
        run: checkov -d . -o json > checkov-report.json || true

      - name: Checkov scan (SARIF)
        run: checkov -d . -o sarif > checkov-report.sarif || true

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: azuredemo/checkov-report.sarif

      # ---------------------------
      # TERRAFORM PLAN
      # ---------------------------

      - name: Terraform Plan
        run: |
          terraform plan -out=tfplan \
            -var="location=${{ github.event.inputs.location }}" \
            -var="vm_size=${{ github.event.inputs.vm_size }}"

      - name: Export plan to JSON
        run: terraform show -json tfplan > tfplan.json

      # ---------------------------
      # INFRACOST
      # ---------------------------

      - name: Install Infracost
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

      - name: Run Infracost breakdown
        run: infracost breakdown --path tfplan.json --format json --out-file infracost.json

      - name: Show cost summary
        run: infracost output --path infracost.json --format table

      # ---------------------------
      # COST POLICY (ejemplo simple)
      # ---------------------------

      - name: Enforce cost policy
        id: cost_policy
        run: |
          MONTHLY_COST=$(jq '.totalMonthlyCost' infracost.json)
          echo "Monthly cost: $MONTHLY_COST"

          LIMIT=50

          if (( $(echo "$MONTHLY_COST > $LIMIT" | bc -l) )); then
            echo "COST_EXCEEDED=true" >> $GITHUB_ENV
            exit 1
          else
            echo "COST_EXCEEDED=false" >> $GITHUB_ENV
          fi

      # ---------------------------
      # PLAN ANALYSIS (Add/Change/Destroy)
      # ---------------------------

      - name: Analyze Terraform Plan (IaC Governance)
        id: plan_analysis
        run: |
          ADDS=$(jq '.resource_changes[] | select(.change.actions[]=="create") | length' tfplan.json | wc -l)
          CHANGES=$(jq '.resource_changes[] | select(.change.actions[]=="update") | length' tfplan.json | wc -l)
          DESTROYS=$(jq '.resource_changes[] | select(.change.actions[]=="delete") | length' tfplan.json | wc -l)

          echo "ADDS=$ADDS" >> $GITHUB_ENV
          echo "CHANGES=$CHANGES" >> $GITHUB_ENV
          echo "DESTROYS=$DESTROYS" >> $GITHUB_ENV

      # ---------------------------
      # PR COMMENT SUMMARY
      # ---------------------------

      - name: Post/Update PR Governance Summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: terraform-governance
          message: |
            ## Terraform Governance Summary

            **Plan Impact**
            - Add: ${{ env.ADDS }}
            - Change: ${{ env.CHANGES }}
            - Destroy: ${{ env.DESTROYS }}

            **Cost Gate**
            - Monthly Cost Checked
            - Limit: $50

      # ---------------------------
      # FINAL GATE
      # ---------------------------

      - name: Final gate (fail if blocked)
        if: env.COST_EXCEEDED == 'true'
        run: exit 1
