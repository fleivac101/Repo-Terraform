name: iac-governance

on:
  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

jobs:
  terraform-governance:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    env:
      WORKDIR: azuredemo/terraform
      MAX_MONTHLY_USD: "50"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: ${{ env.WORKDIR }}
        run: terraform init

      - name: Terraform Validate
        working-directory: ${{ env.WORKDIR }}
        run: terraform validate

      # =========================
      # üîê Checkov ‚Äì Security Scan
      # =========================
      - name: Install Checkov
        run: pip3 install checkov

      - name: Run Checkov (JSON)
        working-directory: ${{ env.WORKDIR }}
        continue-on-error: true
        run: checkov -d . --framework terraform -o json > ../checkov.json

      - name: Run Checkov (SARIF)
        working-directory: ${{ env.WORKDIR }}
        continue-on-error: true
        run: checkov -d . --framework terraform --output sarif --output-file-path checkov.sarif

      - name: Upload Checkov SARIF
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: azuredemo/terraform/checkov.sarif

      # =========================
      # üß© Terraform Plan
      # =========================
      - name: Terraform Plan
        working-directory: ${{ env.WORKDIR }}
        run: terraform plan -out=tfplan

      - name: Export plan to JSON
        working-directory: ${{ env.WORKDIR }}
        run: terraform show -json tfplan > tfplan.json

      # =========================
      # üí∞ Infracost.io
      # =========================
      - name: Install Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Run Infracost
        working-directory: ${{ env.WORKDIR }}
        run: |
          infracost breakdown \
            --path=tfplan.json \
            --format=json \
            --out-file=infracost.json

      # =========================
      # üß† Build summary metrics + TOP 5 resources
      # =========================
      - name: Build summary metrics
        if: always()
        run: |
          python - <<'PY'
          import json, os
          from collections import defaultdict

          def write_env(k, v):
            with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"{k}={v}\n")

          # -------- Plan metrics + Top 5 --------
          add = change = destroy = replace = 0
          per_type = defaultdict(lambda: {"add":0,"change":0,"destroy":0})

          try:
            with open("azuredemo/terraform/tfplan.json") as f:
              plan = json.load(f)

            for rc in plan.get("resource_changes", []):
              rtype = rc.get("type", "unknown")
              actions = rc.get("change", {}).get("actions", [])

              if actions == ["create"]:
                add += 1
                per_type[rtype]["add"] += 1
              elif actions == ["update"]:
                change += 1
                per_type[rtype]["change"] += 1
              elif actions == ["delete"]:
                destroy += 1
                per_type[rtype]["destroy"] += 1
              elif actions == ["delete","create"]:
                replace += 1
                change += 1
                per_type[rtype]["change"] += 1
          except Exception:
            pass

          ranked = sorted(
            per_type.items(),
            key=lambda kv: sum(kv[1].values()),
            reverse=True
          )[:5]

          top5 = []
          for rtype, c in ranked:
            top5.append(f"- `{rtype}` (+{c['add']} ~{c['change']} -{c['destroy']})")

          write_env("PLAN_ADD", add)
          write_env("PLAN_CHANGE", change)
          write_env("PLAN_DESTROY", destroy)
          write_env("PLAN_REPLACE", replace)
          write_env("PLAN_TOP5", "\\n".join(top5) if top5 else "- _No changes detected_")

          # -------- Infracost --------
          try:
            with open("azuredemo/terraform/infracost.json") as f:
              ic = json.load(f)
            write_env("COST_TOTAL", ic.get("totalMonthlyCost", "N/A"))
          except Exception:
            write_env("COST_TOTAL", "N/A")

          # -------- Checkov --------
          high = medium = low = 0
          try:
            with open("azuredemo/checkov.json") as f:
              ck = json.load(f)
            for i in ck.get("results", {}).get("failed_checks", []):
              s = (i.get("severity") or "").upper()
              if s == "HIGH": high += 1
              elif s == "MEDIUM": medium += 1
              elif s == "LOW": low += 1
          except Exception:
            pass

          write_env("CHECKOV_HIGH", high)
          write_env("CHECKOV_MEDIUM", medium)
          write_env("CHECKOV_LOW", low)
          PY

      # =========================
      # üí¨ PR Comment √∫nico (Executive Summary)
      # =========================
      - name: Post PR Governance Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const marker = "<!-- iac-governance-summary -->";
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number, per_page: 100 }
            );

            for (const c of comments) {
              if (c.user.type === "Bot" && c.body.includes(marker)) {
                await github.rest.issues.deleteComment({ owner, repo, comment_id: c.id });
              }
            }

            const body = [
              marker,
              "## üßæ Terraform Governance Summary",
              "",
              "### üß© Terraform Plan",
              `- **Add:** ${process.env.PLAN_ADD}`,
              `- **Change:** ${process.env.PLAN_CHANGE}`,
              `- **Destroy:** ${process.env.PLAN_DESTROY}`,
              "",
              "### üß≠ Top changes (by resource type)",
              (process.env.PLAN_TOP5 || "").replace(/\\n/g, "\n"),
              "",
              "### üîê Security (Checkov)",
              `- **High:** ${process.env.CHECKOV_HIGH}`,
              `- **Medium:** ${process.env.CHECKOV_MEDIUM}`,
              `- **Low:** ${process.env.CHECKOV_LOW}`,
              "",
              "### üí∞ Cost (Infracost)",
              `- **Estimated monthly total:** $${process.env.COST_TOTAL}`,
              "",
              `üîó Workflow run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            ].join("\n");

            await github.rest.issues.createComment({
              owner, repo, issue_number, body
            });
