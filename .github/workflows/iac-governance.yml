name: iac-governance

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  workflow_dispatch:
    inputs:
      location:
        description: "Azure location (example: eastus, westus2)"
        required: true
        default: "eastus"
      vm_size:
        description: "VM size (example: Standard_B2s)"
        required: true
        default: "Standard_B2s"
      break_tags:
        description: "Set to true to intentionally fail governance by removing costCenter tag"
        required: false
        default: "false"

jobs:
  terraform-plan-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: azuredemo/terraform
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.ARM_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).tenantId }}
        run: terraform init

      - name: Terraform Validate
        working-directory: azuredemo/terraform
        run: terraform validate

      # =========================
      # ✅ Nivel 2: IaC Security Scan (Checkov)
      # =========================
      - name: Install Checkov
        run: pip3 install checkov

      # Opción demo: visible pero no bloquea (soft-fail)
      - name: Checkov scan (IaC Security)
        run: checkov -d azuredemo/terraform --soft-fail

      - name: Terraform Plan
        working-directory: azuredemo/terraform
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.ARM_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.ARM_CREDENTIALS).tenantId }}

          # ✅ Works for push / PR / manual:
          TF_VAR_location: ${{ github.event.inputs.location || 'eastus' }}
          TF_VAR_vm_size: ${{ github.event.inputs.vm_size || 'Standard_B2s' }}

          # ✅ Default tags (governance should PASS)
          TF_VAR_tags: '{"owner":"fabian","costCenter":"demo","environment":"dev","application":"iac-governance"}'
        run: |
          # If you want to demonstrate a FAIL by missing costCenter:
          if [ "${{ github.event.inputs.break_tags || 'false' }}" = "true" ]; then
            echo 'TF_VAR_tags={"owner":"fabian","environment":"dev","application":"iac-governance"}' >> $GITHUB_ENV
          fi

          terraform plan -out=tfplan

      - name: Export plan to JSON
        working-directory: azuredemo/terraform
        run: terraform show -json tfplan > tfplan.json

      - name: Analyze Terraform Plan (IaC Governance)
        run: python azuredemo/scripts/analyze_plan.py azuredemo/terraform/tfplan.json
