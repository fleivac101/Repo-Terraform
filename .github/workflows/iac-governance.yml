name: Azure Terraform Plan Gate

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - "azure/**"
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  push:
    branches: [ master, main ]
    paths:
      - "azure/**"
      - "azuredemo/**"
      - ".github/workflows/iac-governance.yml"

  workflow_dispatch:
    inputs:
      location:
        description: "Azure Region"
        required: true
        default: "eastus"
        type: choice
        options:
          - eastus
          - brazilsouth
          - westus
          - centralus

      vm_size:
        description: "Virtual Machine Size"
        required: true
        default: "Standard_B2s"
        type: choice
        options:
          - Standard_B1s
          - Standard_B2s
          - Standard_D2s_v3
          - Standard_D4s_v3

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TF_WORKING_DIR: azuredemo
  TF_IN_AUTOMATION: "true"

jobs:
  terraform-plan-gate:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      # ---------------------------
      # CHECKOV
      # ---------------------------

      - name: Install Checkov
        run: pip install checkov

      - name: Checkov scan (CLI output)
        run: checkov -d . || true

      - name: Checkov scan (JSON)
        run: checkov -d . -o json > checkov-report.json || true

      - name: Checkov scan (SARIF)
        run: checkov -d . -o sarif > checkov-report.sarif || true

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: azuredemo/checkov-report.sarif

      # ---------------------------
      # TERRAFORM PLAN
      # ---------------------------

      - name: Terraform Plan
        run: |
          terraform plan -out=tfplan \
            -var="location=${{ github.event.inputs.location }}" \
            -var="vm_size=${{ github.event.inputs.vm_size }}"

      - name: Export plan to JSON
        run: terraform show -json tfplan > tfplan.json

      # ---------------------------
      # INFRACOST
      # ---------------------------

      - name: Install Infracost
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

      - name: Run Infracost breakdown
        run: infracost breakdown --path tfplan.json --format json --out-file infracost.json

      - name: Show cost summary
        run: infracost output --path infracost.json --format table

      # ---------------------------
      # COST POLICY (ejemplo simple)
      # ---------------------------

      - name: Enforce cost policy
        id: cost_policy
        run: |
          MONTHLY_COST=$(jq '.totalMonthlyCost' infracost.json)
          echo "Monthly cost: $MONTHLY_COST"

          LIMIT=50

          if (( $(echo "$MONTHLY_COST > $LIMIT" | bc -l) )); then
            echo "COST_EXCEEDED=true" >> $GITHUB_ENV
            exit 1
          else
            echo "COST_EXCEEDED=false" >> $GITHUB_ENV
          fi

      # ---------------------------
      # PLAN ANALYSIS (Add/Change/Destroy)
      # ---------------------------

      - name: Analyze Terraform Plan (IaC Governance)
        id: plan_analysis
        run: |
          ADDS=$(jq '.resource_changes[] | select(.change.actions[]=="create") | length' tfplan.json | wc -l)
          CHANGES=$(jq '.resource_changes[] | select(.change.actions[]=="update") | length' tfplan.json | wc -l)
          DESTROYS=$(jq '.resource_changes[] | select(.change.actions[]=="delete") | length' tfplan.json | wc -l)

          echo "ADDS=$ADDS" >> $GITHUB_ENV
          echo "CHANGES=$CHANGES" >> $GITHUB_ENV
          echo "DESTROYS=$DESTROYS" >> $GITHUB_ENV

      # ---------------------------
      # PR COMMENT SUMMARY
      # ---------------------------

      - name: Post/Update PR Governance Summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: terraform-governance
          message: |
            ## Terraform Governance Summary

            **Plan Impact**
            - Add: ${{ env.ADDS }}
            - Change: ${{ env.CHANGES }}
            - Destroy: ${{ env.DESTROYS }}

            **Cost Gate**
            - Monthly Cost Checked
            - Limit: $50

      # ---------------------------
      # FINAL GATE
      # ---------------------------

      - name: Final gate (fail if blocked)
        if: env.COST_EXCEEDED == 'true'
        run: exit 1
