name: IaC Governance â€“ Terraform Plan Gate

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  terraform-plan-gate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    defaults:
      run:
        working-directory: azuredemo/terraform

    steps:
    # -----------------------------
    # Checkout
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # Setup Terraform
    # -----------------------------
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.6

    # -----------------------------
    # Terraform Init & Validate
    # -----------------------------
    - name: Terraform Init
      run: terraform init -input=false

    - name: Terraform Validate
      run: terraform validate

    # =====================================================
    # NIVEL 2 â€“ DevSecOps REAL (Security visible)
    # =====================================================

    - name: Install Checkov
      run: pip3 install checkov

    # --- Checkov CLI output (para PR comment)
    - name: Checkov scan (IaC Security) - CLI
      run: |
        set +e
        checkov -d . --framework terraform --quiet > checkov.txt
        exit 0

    # --- Checkov SARIF (GitHub Security)
    - name: Checkov scan (IaC Security) - SARIF
      run: |
        set +e
        checkov -d . --framework terraform -o sarif > checkov.sarif
        exit 0

    - name: Upload Checkov SARIF
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: azuredemo/terraform/checkov.sarif

    - name: Comment Checkov results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let body = fs.readFileSync('azuredemo/terraform/checkov.txt', 'utf8');
          if (body.length > 60000) body = body.slice(0, 60000) + "\n...(truncated)";
          const comment = [
            "## ðŸ” Checkov â€“ IaC Security Scan",
            "```",
            body,
            "```"
          ].join("\n");
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body
          });

    # =====================================================
    # NIVEL 1 â€“ Governance determinista (Plan gate)
    # =====================================================

    - name: Terraform Plan
      run: |
        terraform plan \
          -out=tfplan \
          -var="location=westeurope" \
          -var="vm_size=Standard_B2s" \
          -var='tags={
            owner="fabian",
            costCenter="demo",
            environment="dev",
            application="iac-governance"
          }'

    - name: Export plan to JSON
      run: terraform show -json tfplan > tfplan.json

    - name: Analyze Terraform Plan (IaC Governance)
      run: |
        python ../scripts/analyze_plan.py tfplan.json
